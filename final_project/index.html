
<!DOCTYPE html>
<html>
  <head> 
    <title>Progetto Finale -  Andrea Olivieri</title> 
    <style>
      body{
        margin: 0;
        overflow: hidden;
      }

      #stats {  /* Align stats top-left */
        position: absolute;
        left: 0px;
        top: 0px;
      }
    </style> 
  </head>
  <body>
  <!-- JavaScript libraries -->
  <script type="text/javascript" src="assets/libs/jquery.min.js"></script> 
  <script type="text/javascript" src="assets/libs/three.min.js"></script>
  <script type="text/javascript" src="assets/libs/Stats.min.js"></script>
  <script type="text/javascript" src="assets/libs/dat.gui.min.js"></script>
  <script type="text/javascript" src="assets/libs/TrackballControls.js"></script>
  <script type="text/javascript" src="assets/libs/FirstPersonControls.js"></script>
  <script type="text/javascript" src="assets/libs/OBJLoader.js"></script> 
  <script type="text/javascript" src="assets/libs/MTLLoader.js"></script> 
  <script type="text/javascript" src="assets/libs/OBJMTLLoader.js"></script> 

  <script type="text/javascript" src="scripts/apartment.js"></script> 
  <script type="text/javascript" src="scripts/lamp.js"></script> 
  <script type="text/javascript" src="scripts/door.js"></script> 
  <script type="text/javascript" src="scripts/wallpaper.js"></script> 
  <script type="text/javascript" src="scripts/window.js"></script> 
  <script type="text/javascript" src="scripts/bathroom.js"></script> 
  <script type="text/javascript" src="scripts/bedroom.js"></script> 
  <script type="text/javascript" src="scripts/livingroom.js"></script> 
  <!-- Javascript code that runs our Three.js examples --> 
  <script>
    // once everything is loaded, we run our Three.js stuff.
    $(Document).ready(function () {
      //var clock = new THREE.Clock();

      var stats = initStats();

      // create a scene, that will hold all our elements such as objects, cameras and lights.
      var scene = new THREE.Scene();
      scene.name = 'Scene';

      // create a camera, which defines where we're looking at.
      var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.name = 'Camera';
      camera.position.set(0, -10, 20);
      camera.lookAt(new THREE.Vector3(0, 0, 0));

      // create trackball controls
      var trackballControls = new THREE.TrackballControls(camera);

/*
      var camControls = new THREE.FirstPersonControls(camera);
      camControls.lookSpeed = 0.05;
      camControls.movementSpeed = 2;
      camControls.activeLook = true;
      camControls.noFly = true;
      camControls.lookVertical = true;
      camControls.constrainVertical = true;
     // camControls.verticalMin = 1.0;
     // camControls.verticalMax = 2.0;
      camControls.lon = -150;
      camControls.lat = 120;
*/
      // create a render and set the size
      var webGLRenderer = new THREE.WebGLRenderer();
      webGLRenderer.setClearColor(new THREE.Color(0x62BDF5, 1.0));
      webGLRenderer.setSize(window.innerWidth, window.innerHeight);
      webGLRenderer.shadowMapEnabled = true;
    

      var axisHelper = new THREE.AxisHelper(10);
      axisHelper.name = 'Axis';
      scene.add(axisHelper);

      var projector = new THREE.Projector();

      // load apartment from obj  
      var apartment = addApartment(scene); 

      addBathroomOBJs(scene);      

      addBedroomOBJs(scene);  

      addLivingroomOBJs(scene);    

      // load apartment from obj  
      addWallpapers(scene);       
      
      // Load Ceiling Lamps
      var cLamps;
      //cLamps = addCeilingLamps(scene); 

      // Load Doors
      var doors; 
      //doors = addDoors(scene); 

      // Load Windows
      var windows; 
      windows = addWindows(scene); 


      // add spotlight for the shadows
      var spotLight = new THREE.SpotLight(0xffffff);
      spotLight.shadowCameraVisible = true;
      spotLight.position.set(30, 0, 10);
      spotLight.target.position.set( 0, 0, 0 );
      spotLight.intensity = 0.4;
      scene.add(spotLight);

      var spotLight = new THREE.SpotLight(0xffffff);
      spotLight.shadowCameraVisible = true;
      spotLight.position.set(-30, 0, 40);
      spotLight.target.position.set( 0, 0, 0 );
      spotLight.intensity = 0.4;
      scene.add(spotLight);

      var spotLight = new THREE.SpotLight(0xffffff);
      spotLight.shadowCameraVisible = true;
      spotLight.position.set(0, 30, 40);
      spotLight.target.position.set( 0, 0, 0 );
      spotLight.intensity = 0.4;
      scene.add(spotLight);

      var spotLight = new THREE.SpotLight(0xffffff);
      spotLight.shadowCameraVisible = true;
      spotLight.position.set(0, -30, 40);
      spotLight.target.position.set( 0, 0, 0 );
      spotLight.intensity = 0.4;
      scene.add(spotLight);
      



      var shape = createMesh(new THREE.ShapeGeometry(drawShape(2.001,2.001,0.501,0.501,1.001,1.001)));
      shape.rotation.x = Math.PI/2.;
      // add the sphere to the scene
      scene.add(shape);


      // Add OnMouseDown Listener
      document.addEventListener('mousedown', onDocumentMouseDown, false);

      // add the output of the renderer to the html element
      $('body').append(webGLRenderer.domElement);

      var controls = new function () {
        
        this.X   = 0.001;
        this.Y   = 0.001;
        this.Phi = 0;
        this.basisExt= 2.001; 
        this.deltaX= 0.501; 
        this.deltaY= 0.501; 
        this.basisInt= 1.001; 
        this.heightInt = 1.001;

        this.timeState = 'Day'; 

        };

        var gui = new dat.GUI();
        gui.add(controls, 'X', -10.0, 10.0).onChange(function (value) {
          shape.position.x = value; 
        });
        gui.add(controls, 'Y', -10.0, 10.0).onChange(function (value) {
          shape.position.y = value; 
        });
        gui.add(controls, 'Phi', 0, 4).onChange(function (value) {
          shape.rotation.y = value * Math.PI/2.; 
        });
        gui.add(controls, 'basisExt', -10.0, 10.0).onChange(function (value) {
          scene.remove(shape);
          shape = createMesh(new THREE.ShapeGeometry(drawShape(value, 2.8, 
                  controls.deltaX, controls.deltaY, controls.basisInt, controls.heightInt
                  )));
          shape.position.set(controls.X, controls.Y, 1.201);
          shape.rotation.x = Math.PI/2.;
          shape.rotation.y = controls.Phi* Math.PI/2.;
          scene.add(shape); 
        });
        gui.add(controls, 'deltaX', 0.001, 10.0).onChange(function (value) {
          scene.remove(shape);
          shape = createMesh(new THREE.ShapeGeometry(drawShape(controls.basisExt, 2.8, 
                  value, controls.deltaY, controls.basisInt, controls.heightInt
                  )));
          shape.position.set(controls.X, controls.Y, 1.201);
          shape.rotation.x = Math.PI/2.;
          shape.rotation.y = controls.Phi* Math.PI/2.;
          scene.add(shape); 
        });
        gui.add(controls, 'deltaY', 0.001, 10.0).onChange(function (value) {
          scene.remove(shape);
          shape = createMesh(new THREE.ShapeGeometry(drawShape(controls.basisExt, 2.8, 
                  controls.deltaX, value, controls.basisInt, controls.heightInt
                  )));
          shape.position.set(controls.X, controls.Y, 1.201);
          shape.rotation.x = Math.PI/2.;
          shape.rotation.y = controls.Phi* Math.PI/2.;
          scene.add(shape); 
        });
        gui.add(controls, 'basisInt', -10.0, 10.0).onChange(function (value) {
          scene.remove(shape);
          shape = createMesh(new THREE.ShapeGeometry(drawShape(controls.basisExt, 2.8, 
                  controls.deltaX, controls.deltaY, value, controls.heightInt
                  )));
          shape.position.set(controls.X, controls.Y, 1.201);
          shape.rotation.x = Math.PI/2.;
          shape.rotation.y = controls.Phi* Math.PI/2.;
          scene.add(shape); 
        });
        gui.add(controls, 'heightInt', -10.0, 10.0).onChange(function (value) {
          scene.remove(shape);
          shape = createMesh(new THREE.ShapeGeometry(drawShape(controls.basisExt, 2.8, 
                  controls.deltaX, controls.deltaY, controls.basisInt, value
                  )));
          shape.position.set(controls.X, controls.Y, 1.201);
          shape.rotation.x = Math.PI/2.;
          shape.rotation.y = controls.Phi* Math.PI/2.;
          scene.add(shape); 
        });
        gui.add(controls, 'timeState', ['Night', 'Day']).onChange(function (e){
          if(e === 'Day'){
            webGLRenderer.setClearColor(new THREE.Color(0x62BDF5, 1.0));
          }

          if(e === 'Night'){
            webGLRenderer.setClearColor(new THREE.Color(0x1C15D5, 1.0));
          }
        });

        
      

      render();


      function render() {
        stats.update();

        /*
        var delta = clock.getDelta();
        camControls.update(delta);
        */
        trackballControls.update();

        // render using requestAnimationFrame
        requestAnimationFrame(render);
        webGLRenderer.render(scene, camera);
      }

      function initStats() {
        var stats = new Stats();
        stats.setMode(0); // 0: fps, 1: ms
        $('body').append(stats.domElement);
        return stats;
      }

      function onDocumentMouseDown (event) {
        event.preventDefault();

        // map viewport coordinates in ([-1,1], [-1,1], 0.5)
        var vector = new THREE.Vector3(( event.clientX / window.innerWidth ) * 2 - 1, -( event.clientY / window.innerHeight ) * 2 + 1, 0.5);
        projector.unprojectVector(vector, camera);

        var raycaster = new THREE.Raycaster(camera.position, 
          vector.sub(camera.position).normalize());

        var intersects;


        if (cLamps != undefined){
          intersects = raycaster.intersectObjects(cLamps,true);
          if (intersects.length > 0) {
            intersects[0].object.parent.parent.parent.onMouseDown();
          }
         }

        if (doors != undefined){ 
          intersects = raycaster.intersectObjects(doors,true);
          if (intersects.length > 0) {
            intersects[0].object.parent.parent.onMouseDown();
          }
        }  
             
      }


      function drawShape(basisExt, heightExt, deltaX, deltaY, basisInt, heightInt) {

        var shape = new THREE.Shape();
        shape.moveTo(0, 0);
        shape.lineTo(basisExt, 0);
        shape.lineTo(basisExt, heightExt);
        shape.lineTo(0, heightExt);
        shape.lineTo(0, 0);
        

        var hole1 = new THREE.Path();
        hole1.moveTo(deltaX, deltaY);
        hole1.lineTo(deltaX+basisInt, deltaY);
        hole1.lineTo(deltaX+basisInt, deltaY+heightInt);
        hole1.lineTo(deltaX, deltaY+heightInt);
        hole1.lineTo(deltaX, deltaY);
        shape.holes.push(hole1);

        return shape;
      }

      function createMesh (geom) {

        // assign two materials
        var meshMaterial = new THREE.MeshPhongMaterial({color: 0xfff333});
        //meshMaterial.side = THREE.DoubleSide;
        //meshMaterial.map  = THREE.ImageUtils.loadTexture("assets/textures/balconyFloor.jpg");
        var wireFrameMat = new THREE.MeshBasicMaterial();
        //wireFrameMat.wireframe = true;

        // create a multimaterial
        var mesh = THREE.SceneUtils.createMultiMaterialObject(geom, [meshMaterial, wireFrameMat]);

        return mesh;
      }



    });
  </script>  
 </body>
</html>
